<!DOCTYPE html><html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <title>Math Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Helvetica Neue', sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow: hidden;
      color: #2c3e50;
    }h1 {
  font-size: 1.2em;
  margin: 0.3em;
}

#mode-select {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.8em;
  margin: 0.5em;
  font-size: 1em;
}
#mode-select label {
  display: flex;
  align-items: center;
  gap: 0.2em;
}

#question {
  font-size: 1.6em;
  margin: 0.3em;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-left: 2em;
  margin-bottom: 0em;
  height: 70px;
}
.question-number {
  font-size: 0.6em;
  color: #888;
  margin-right: 0.6em;
  white-space: nowrap;  /* â† æ”¹è¡Œã•ã›ãªã„ï¼ */
}

#answerInput {
  font-size: 1em;
  font-weight: bold;
  margin-left: 0.5em;
  min-width: 4em;

}

#result {
  font-size: 1.0em;
  height: 1.1em;
  margin: 0.1em;
}

.keypad-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.4em;
  width: 100%;
  max-width: 320px;
  margin-top: 0.8em;  /* â† ã“ã‚Œã‚’è¿½åŠ ï¼ */
}

.keypad-grid button {
  padding: 0.6em 0.8em; /* ç¸¦æ–¹å‘ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
  font-size: 1.2em;     /* æ–‡å­—ã‚µã‚¤ã‚ºã‚‚å°‘ã—æ§ãˆã‚ã« */
  border: none;
  border-radius: 8px;
  color: white;
}

.keypad-grid button:not(.btn-ok):not(.btn-delete) {
  background: #3498db;
}

.btn-delete {
  background: #e74c3c !important;
}

.btn-delete:hover {
  background: #c0392b !important;
}

.btn-ok {
  background: #2ecc71 !important;
}

.btn-ok:hover {
  background: #27ae60 !important;
}

.keypad-grid button:hover {
  filter: brightness(0.95);
}

#restartBtn {
  margin-top: 1em;
  padding: 0.6em 1.2em;
  font-size: 1.2em;
  background: #2ecc71;
  border: none;
  border-radius: 6px;
  color: white;
}

#memo-container {
  margin: 0.2em 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  
  border-top: 1px solid #ccc;  /* â† åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ  */
  padding-top: 0.5em;          /* ç·šã¨ä¸‹ã®ä½™ç™½ */
  margin-top: 0.8em;           /* ç·šã¨ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã®é–“éš” */
}
#memo-buttons {
  display: flex;
  gap: 0.6em;
  margin-top: 0.5em;
}
#clearBtn {
  margin-top: 0.5em;
  padding: 0.3em 0.7em;
  font-size: 1em;
  border: none;
  border-radius: 6px;
  background: #e67e22;
  color: white;
  }
#hissanBtn {
  margin-top: 0.5em;
  padding: 0.3em 0.7em;
  font-size: 1em;
  border: none;
  border-radius: 6px;
  background: #2ecc71;
  color: white;
}
#swapBtn {
  display: none;  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
}
body.hissan-mode #swapBtn {
  display: inline-block;  /* ç­†ç®—ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘è¡¨ç¤º */
}
.small-btn {
  margin-top: 0.5em;
  padding: 0.3em 0.6em;
  font-size: 0.8em;
  border: none;
  border-radius: 6px;
  background: #95a5a6;
  color: white;
}
#memo-canvas {
  border: 1px solid #ccc;
  background: #f5f5f5; /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚°ãƒ¬ãƒ¼ */
  touch-action: none;
  width: 90vw;
  height: 25vh;
  max-height: 200px;
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
@media (prefers-color-scheme: dark) {
  #memo-canvas {
    background: #2c2c2c; /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
    border-color: #444;
  }
}



  </style>
</head>
<body><h1>Math Practiceâœï¸ğŸ”¥</h1>
<div id="mode-select">
  <label><input type="radio" name="mode" value="all" checked> all</label>
  <label><input type="radio" name="mode" value="+"> ï¼‹</label>
  <label><input type="radio" name="mode" value="-"> âˆ’</label>
  <label><input type="radio" name="mode" value="Ã—"> Ã—</label>
  <label><input type="radio" name="mode" value="Ã·"> Ã·</label>
</div>
<div id="result"> </div>
<div id="question">
  <span id="questionNumber" class="question-number"></span>
  <span id="problemText">èª­ã¿è¾¼ã¿ä¸­...</span>
  <span id="answerInput"> </span>
</div>
  <div id="memo-container">
  <canvas id="memo-canvas" width="300" height="150"></canvas>
<div id="memo-buttons">
  <button id="clearBtn">clear memo</button> 
  <button id="eraserBtn" class="small-btn">eraser</button>
  <button id="hissanBtn">column on</button>
  <button id="swapBtn" class="small-btn">switch</button>
</div>
</div>
<div class="keypad-grid" id="keypad"></div>

<script>
  // å¤‰æ•°ã®åˆæœŸåŒ–
  let problems = [];
  let current = 0;
  let score = 0;
  let waitForUser = false;
  let userInput = "";
  let swapHissanOrder = false;
  
  // Canvasé–¢é€£ã®å¤‰æ•°
  const canvas = document.getElementById("memo-canvas");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let penMode = true; // true: pen, false: eraser

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').then(registration => {
        registration.onupdatefound = () => {
          const newWorker = registration.installing;
          newWorker.onstatechange = () => {
            if (newWorker.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                if (confirm('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                  location.reload();
                }
              }
            }
          };
        };
      });
    });
  }

  document.getElementById("hissanBtn").addEventListener("click", () => {
    document.body.classList.toggle("hissan-mode");
    const isOn = document.body.classList.contains("hissan-mode");
    document.getElementById("hissanBtn").textContent = isOn ? "column off" : "column on";
    showProblem();
  });

  function hissanOff() {
    if (document.body.classList.contains("hissan-mode")) {
      document.body.classList.remove("hissan-mode");
    }
    document.getElementById("hissanBtn").textContent = "column on";
  }

  function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function randList(...numbers) {
    const index = Math.floor(Math.random() * numbers.length);
    return numbers[index];
  }

  function getDigitLength(n) {
    const intPart = Math.floor(Math.abs(n));
    return intPart.toString().length;
  }

  function getDecimalLength(n) {
    const fixed = n.toFixed(2);
    const parts = fixed.split(".");
    return parts[1] ? parts[1].replace(/0+$/, "").length : 0;
  }

  function getSelectedOperators() {
    const selected = document.querySelector('input[name="mode"]:checked').value;
    return selected === "all" ? ["+", "-", "Ã—", "Ã·"] : [selected];
  }

  function generateProblems() {
    problems = [];
    const selectedOperators = getSelectedOperators();

    for (let i = 0; i < 10; i++) {
      const op = selectedOperators[Math.floor(Math.random() * selectedOperators.length)];
      let a, b, ans;

      if (op === "+") {
        do {
          a = parseFloat((rand(11, 999) / randList(1, 1, 10, 100)).toFixed(2));
          b = parseFloat((rand(11, 999) / randList(1, 1, 10, 100)).toFixed(2));
        } while (
          Math.abs(getDecimalLength(a) - getDecimalLength(b)) >= 2 ||
          Math.abs(getDigitLength(a) - getDigitLength(b)) >= 2
        );
        ans = parseFloat((a + b).toFixed(2));
      } else if (op === "-") {
        do {
          a = parseFloat((rand(11, 999) / randList(1, 1, 10, 100)).toFixed(2));
          b = parseFloat((rand(11, 999) / randList(1, 1, 10, 100)).toFixed(2));
        } while (
          Math.abs(getDecimalLength(a) - getDecimalLength(b)) >= 2 ||
          Math.abs(getDigitLength(a) - getDigitLength(b)) >= 2
        );
        ans = parseFloat((a - b).toFixed(2));
      } else if (op === "Ã—") {
        if (Math.random() < 0.5) {
        // ä¸€æ–¹ãŒ3æ¡ã€ã‚‚ã†ä¸€æ–¹ãŒ1æ¡ï¼ˆé †ä¸åŒï¼‰
        const big = parseFloat((rand(101, 999) / randList(1, 1, 10, 100)).toFixed(2));
        const small = parseFloat((rand(2, 9) / randList(1, 1, 10, 100)).toFixed(2));
        if (Math.random() < 0.5) {
          a = big; b = small;  // 3æ¡ Ã— 1æ¡
        } else {
          a = small; b = big;  // 1æ¡ Ã— 3æ¡
        }
        } else {
        // 2æ¡ Ã— 2æ¡
         a = parseFloat((rand(11, 99) / randList(1, 1, 10, 100)).toFixed(2));
         b = parseFloat((rand(11, 99) / randList(1, 1, 10, 100)).toFixed(2));
        }
        ans = parseFloat((a * b).toFixed(4));
      } else if (op === "Ã·") {
        a = rand(10, 999);
        b = rand(11, 99);
  
  // ç­”ãˆã‚’è¨ˆç®—ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹2æ¡ã¾ã§ä¿æŒï¼‰
  const rawAns = a / b;
  
  // æ•´æ•°éƒ¨åˆ†ã®æ¡æ•°ã‚’å–å¾—
  const intDigits = Math.floor(Math.abs(rawAns)) === 0 ? 0 : 
                   Math.floor(Math.log10(Math.floor(Math.abs(rawAns)))) + 1;
  
  if (intDigits >= 2) {
    // æ•´æ•°éƒ¨åˆ†ãŒ2æ¡ä»¥ä¸Šãªã‚‰æ•´æ•°ã®ã¿
    ans = Math.floor(rawAns);
  } else if (intDigits === 1) {
    // æ•´æ•°éƒ¨åˆ†ãŒ1æ¡ãªã‚‰å°æ•°ç¬¬1ä½ã¾ã§
    ans = Math.floor(rawAns * 10) / 10;
  } else {
    // æ•´æ•°éƒ¨åˆ†ãŒ0ãªã‚‰å°æ•°ç¬¬2ä½ã¾ã§
    ans = Math.floor(rawAns * 100) / 100;
        }
      }

      problems.push({ a, b, op, ans });
    }

    current = score = 0;
    waitForUser = false;
    
    // ã“ã“ã§ãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦è¨­å®š
    ctx.fillStyle = getMemoBackgroundColor();
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    showProblem();
  }
  function showProblem() {
  if (current >= problems.length) return showResult();

  const p = problems[current];
  const ishissan = document.body.classList.contains("hissan-mode");

  document.getElementById("questionNumber").textContent = `Q${current + 1}.`;
  
  // å‰²ã‚Šç®—ã®å ´åˆã€åˆ‡ã‚Šæ¨ã¦æŒ‡ç¤ºã‚’ç”Ÿæˆ
  let divisionInstruction = "";
  if (p.op === "Ã·") {
    // æ•´æ•°éƒ¨åˆ†ã®æ¡æ•°ã‚’å–å¾—
    const rawAns = p.a / p.b;
    const intDigits = Math.floor(Math.abs(rawAns)) === 0 ? 0 : 
                     Math.floor(Math.log10(Math.floor(Math.abs(rawAns)))) + 1;
    
    if (intDigits >= 2) {
      divisionInstruction = "ï¼ˆå°æ•°éƒ¨åˆ†ã¯åˆ‡ã‚Šæ¨ã¦ï¼‰";
    } else if (intDigits === 1) {
      divisionInstruction = "ï¼ˆå°æ•°ç¬¬2ä½ä»¥ä¸‹ã¯åˆ‡ã‚Šæ¨ã¦ï¼‰";
    } else {
      divisionInstruction = "ï¼ˆå°æ•°ç¬¬3ä½ä»¥ä¸‹ã¯åˆ‡ã‚Šæ¨ã¦ï¼‰";
    }
  }

  if (ishissan) {
    // å‰²ã‚Šç®—ã®å ´åˆã¯ç‰¹åˆ¥ãªè¡¨ç¤º
    if (p.op === "Ã·") {
      document.getElementById("problemText").innerHTML = `
        <div style="text-align:right; font-family: Menlo, Consolas, monospace; line-height:1.1; margin:0;">
          ${p.a} / ${p.b}
        </div>
        <div style="font-size:0.4em; color:#666; margin-top:0.5em;">${divisionInstruction}</div>`;
    } else {
      // ä»–ã®æ¼”ç®—ã®å ´åˆã¯å¾“æ¥é€šã‚Š
      const format = n => n.toFixed(2).replace(/\.?0+$/, '');
      const aStr = format(p.a);
      const bStr = format(p.b);
      const [ai, apRaw = ""] = aStr.split(".");
      const [bi, bpRaw = ""] = bStr.split(".");
      const ap = apRaw ? '.' + apRaw : '  ';
      const bp = bpRaw ? '.' + bpRaw : '  ';
      const leftMax = Math.max(ai.length, bi.length);
      const rightMax = Math.max(ap.length, bp.length);
      const aiPad = ai.padStart(leftMax, " ");
      const biPad = bi.padStart(leftMax, " ");
      const apPad = ap.padEnd(rightMax, " ");
      const bpPad = bp.padEnd(rightMax, " ");

      let aLine = aiPad + apPad;
      let bLine = p.op + biPad + bpPad;
      // å¼•ãç®—ã§ç­”ãˆãŒè² ãªã‚‰ aã¨bã‚’å…¥ã‚Œæ›¿ãˆã‚‹
      if ((p.op === "-") && (p.a - p.b < 0)) {
        [aLine, bLine] = [bLine, aLine];
      }
      if (swapHissanOrder) {
        [aLine, bLine] = [bLine, aLine];
      }
      
      document.getElementById("problemText").innerHTML = `
        <pre style="text-align:right; font-family: Menlo, Consolas, monospace; line-height:1.1; margin:0;">
${aLine}
${bLine}</pre>
        <div style="font-size:0.8em; color:#666; margin-top:0.5em;">${divisionInstruction}</div>`;
    }
  } else {
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®è¡¨ç¤º
    if (divisionInstruction) {
      document.getElementById("problemText").innerHTML = `${p.a} ${p.op} ${p.b} = <div style="font-size:0.4em; color:#666; margin-top:0.2em;">${divisionInstruction}</div>`;
    } else {
      document.getElementById("problemText").textContent = `${p.a} ${p.op} ${p.b} =`;
    }
  }

  userInput = "";
  updateInput();
  document.getElementById("result").textContent = "";
}

  document.getElementById("swapBtn").addEventListener("click", () => {
    swapHissanOrder = !swapHissanOrder;
    showProblem(); // ã™ãã«åæ˜ 
  });

  function updateInput() {
    document.getElementById("answerInput").textContent = userInput || " ";
  }

  function setupKeypad() {
    const keys = [
      "7", "8", "9", "Delete",
      "4", "5", "6", "",
      "1", "2", "3", "ENTER",
      "-", "0", ".", ""
    ];

    const keypad = document.getElementById("keypad");
    keypad.innerHTML = "";

    keys.forEach(k => {
      const btn = document.createElement("button");
      if (k === "") {
        btn.style.visibility = "hidden";
      } else {
        btn.textContent = k;
        if (k === "Delete") btn.classList.add("btn-delete");
        else if (k === "ENTER") btn.classList.add("btn-ok");
        btn.onclick = () => handleKey(k);
      }
      keypad.appendChild(btn);
    });
  }
function handleKey(key) {
  if (waitForUser) return;

  if (key === "Delete") {
    // ã€Œ0.ã€ã®ã¨ãã¯ä¸€åº¦ã«ä¸¡æ–¹å‰Šé™¤ã™ã‚‹
    if (userInput === "0.") {
      userInput = "";
    } else if (userInput === "-0.") {
      // ã€Œ-0.ã€ã®å ´åˆã¯ã€Œ-ã€ã ã‘æ®‹ã™
      userInput = "-";
    } else {
      userInput = userInput.slice(0, -1);
    }
  } else if (key === "ENTER") {
    if (userInput.trim() === "" || userInput === "-") return;
    checkAnswer();
  } else if (key === "-") {
    if (userInput === "") userInput = "-";
  } else if (key === ".") {
    if (userInput === "") {
      userInput = "0.";
    } else if (userInput === "-") {
      userInput = "-0.";
    } else if (!userInput.includes(".")) {
      userInput += key;
    }
  } else {
    userInput += key;
  }

  updateInput();
}

  function checkAnswer() {
    const p = problems[current];
    const userNum = parseFloat(userInput);
    const correct = Math.abs(userNum - p.ans) < 0.001;
    const resultBox = document.getElementById("result");

    if (correct) {
      score++;
      resultBox.textContent = "Correct! ğŸ‘";
      setTimeout(() => advanceNext(), 800);
    } else {
      resultBox.textContent = `IncorrectğŸ˜¢: ${p.ans}`;
      setTimeout(() => {
        waitForUser = true;
      }, 500);
    }
  }

  function advanceNext() {
    waitForUser = false;
    current++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦è¨­å®š
    ctx.fillStyle = getMemoBackgroundColor();
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    swapHissanOrder = false;
    showProblem();
  }

  document.addEventListener("click", (e) => {
    if (waitForUser) {
      advanceNext();
      e.stopPropagation();
    }
  });

  function showResult() {
const msg = (score === 10) ? "Perfect score! Genius level!"
            : (score >= 8) ? "Nice work! Just a bit more!"
            : (score >= 5) ? "You're doing well!"
            : (score >= 3) ? "You're getting there! Keep going!"
            : "Now the real challenge begins...";

    const emoji = (score === 10) ? "ğŸ’¯âœ¨ğŸ‘"
                : (score >= 8) ? "ğŸ‘ğŸŒŸ"
                : (score >= 5) ? "ğŸ˜ŠâœŒï¸"
                : (score >= 3) ? "ğŸ™ŒğŸ“ˆ"
                : "ğŸ˜…ğŸ”¥";

    document.body.innerHTML = `
      <style>
        body {
          background: #fffdf5;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          animation: fadeIn 1s ease-in-out;
        }
        h1 {
          font-size: 2em;
          animation: popIn 0.6s ease-out;
          margin-bottom: 0.3em;
        }
        .score-msg, .emoji {
          font-size: 1.6em;
          margin: 0.4em 0;
          animation: sway 2s ease-in-out infinite alternate;
        }
        .emoji { font-size: 2.2em; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes sway { 0% { transform: rotate(-3deg); } 100% { transform: rotate(3deg); } }
        #restartBtn {
          margin-top: 1.2em;
          padding: 0.7em 1.4em;
          font-size: 1.2em;
          background: #f39c12;
          color: white;
          border: none;
          border-radius: 10px;
          animation: popIn 1s ease-out;
        }
        #restartBtn:hover { background: #e67e22; }
      </style>
      <h1>Good jobï¼</h1>
      <div class="emoji">${emoji}</div>
      <div class="score-msg">Scoreï¼š${score} / 10</div>
      <div class="score-msg">${msg}</div>
      <button id="restartBtn" onclick="location.reload()">Try againï¼</button>
      
    `;
  }

  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ¤œå‡º
  function isDarkMode() {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }

  // ãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰²ã‚’ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦è¨­å®š
  function getMemoBackgroundColor() {
    return isDarkMode() ? "#2c2c2c" : "#f5f5f5";
  }

  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
  function initCanvas() {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦è¨­å®š
    ctx.fillStyle = getMemoBackgroundColor();
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  // æç”»é–¢é€£ã®å‡¦ç†ã‚’æ•´ç†
  // æç”»é–‹å§‹
  function startDraw(e) {
    drawing = true;
    const x = getX(e);
    const y = getY(e);
    ctx.beginPath();
    setDrawingStyle();
    ctx.moveTo(x, y);
  }

  // æç”»ä¸­
  function draw(e) {
    if (!drawing) return;
    const x = getX(e);
    const y = getY(e);
    setDrawingStyle();
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }

  // æç”»ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
  function setDrawingStyle() {
    ctx.lineWidth = penMode ? 2 : 15;
    ctx.strokeStyle = penMode ? (isDarkMode() ? "#ccc" : "gray") : getMemoBackgroundColor();
    ctx.lineCap = "round";
  }

  // æç”»çµ‚äº†
  function endDraw() {
    drawing = false;
    ctx.closePath();
  }

  // Xåº§æ¨™ã‚’å–å¾—
  function getX(e) {
    const rect = canvas.getBoundingClientRect();
    // canvasè¦ç´ ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å†…éƒ¨ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è€ƒæ…®
    const scaleX = canvas.width / rect.width;
    return ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) * scaleX;
  }

  // Yåº§æ¨™ã‚’å–å¾—
  function getY(e) {
    const rect = canvas.getBoundingClientRect();
    // canvasè¦ç´ ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å†…éƒ¨ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è€ƒæ…®
    const scaleY = canvas.height / rect.height;
    return ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top) * scaleY;
  }
  
  // clearBtnã‚¯ãƒªãƒƒã‚¯æ™‚
  document.getElementById("clearBtn").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ã‚­ãƒ£ãƒ³ãƒã‚¹èƒŒæ™¯ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦è¨­å®š
    ctx.fillStyle = getMemoBackgroundColor();
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  });

  // æ¶ˆã—ã‚´ãƒ ãƒœã‚¿ãƒ³ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  document.getElementById("eraserBtn").addEventListener("click", function() {
    penMode = !penMode;
    this.textContent = penMode ? "eraser" : "pen";
    this.style.background = penMode ? "#95a5a6" : "#3498db";
  });

  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ¤œå‡º
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    updateMemoBackground();
  });

  // ãƒ¡ãƒ¢èƒŒæ™¯ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateMemoBackground() {
    const memoBackgroundColor = getMemoBackgroundColor();
    ctx.fillStyle = memoBackgroundColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    draw(e);
  }, { passive: false });
  canvas.addEventListener("touchend", endDraw);
  canvas.addEventListener("touchcancel", endDraw);

  document.querySelectorAll('input[name="mode"]').forEach(input => {
    input.addEventListener("change", () => {
      swapHissanOrder = false;
      generateProblems();
    });
  });

  // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
  initCanvas();
  generateProblems();
  setupKeypad();
</script>
</body>
</html>
